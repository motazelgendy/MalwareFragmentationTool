#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

// #include <udis86.h>
#include <bfd.h>
#include <opdis/opdis.h>

#include "pe_analyzer.h"
#include "disasx86.h"
#include "disasx86_flow.h"
#include "imports.h"
#include "general_analysis.h"
#include "strings_dump.h"
#include "hex_dump_sections.h"

#define DEFAULT "no"
#define REV(X)      ((X << 24) | (((X>>16)<<24)>>16) | (((X<<16)>>24)<<16) | (X>>24))

void Usage(char *filename){
	printf("\n########################################\n");
	printf("# Welcome To The Malware Fragmentation Tool #\n");
	printf("# Author : Motaz Reda                  #\n");
	printf("########################################\n");
	printf("Usage: \n");
	printf("\t-a <filename> for display all Information analyzed\n");
	printf("\t-I <filename> for display import table information\n");
	printf("\t-n <section name> <filename> for display section information\n");
	printf("\t-N <section name> <filename> for display hex dump for section choosed information\n");
	printf("\t-s <filename> Dump all sections information\n");
	printf("\t-S <section name> <filename> dump Strings for choosed secion \n");
	printf("\t-d <filename> Disassemble from default Entry Point \n");
	printf("\t-c <filename> Disassemble Flow Oriented from default Entry Point \n");
	exit(0);
}


// here the function responsble for listing sections 
void ListSections(unsigned char *buffer, char opt){
	IMAGE_DOS_HEADER *dos;
	IMAGE_NT_HEADERS *ntheader;
	IMAGE_IMPORT_DESCRIPTOR *import_desc;
	PIMAGE_THUNK_DATA *names;

	int n, section_size = 0;
	int data_dir;
	char *data_dir_desc;

	int import_count = 0; //for count imports

	printf("\t########Begin Analyzing########\n");
	// Dos Header
	dos = (IMAGE_DOS_HEADER *)buffer;
	// End Dos Header
	// begin Pe Header
	unsigned char *PE_HEADER = (unsigned char *)malloc(sizeof(buffer[dos->e_lfanew])); //allocate
	PE_HEADER = &buffer[dos->e_lfanew];
	ntheader = (IMAGE_NT_HEADERS *)PE_HEADER;
	printf("\t#####Section Header#####\n");
	int g=0;
	int realoffset[ntheader->file_header.NumberOfSections];
	for(n=1;n<=ntheader->file_header.NumberOfSections;n++) {
		IMAGE_SECTION_HEADER *secheader = (IMAGE_SECTION_HEADER *)(PE_HEADER + sizeof(IMAGE_NT_HEADERS) + section_size);
		section_size += sizeof(IMAGE_SECTION_HEADER);
		printf("\tSection Name: %c%c%c%c%c%c%c%c\n", secheader->Name[0], secheader->Name[1], secheader->Name[2], secheader->Name[3], secheader->Name[4], secheader->Name[5], secheader->Name[6], secheader->Name[7]);
		printf("\tVirtualSize: %04x\n", secheader->VirtualSize);
		printf("\tVirtualAddress: %04x\n", secheader->VirtualAddress);
		printf("\tSizeOfRawData: %04x\n", secheader->SizeOfRawData);
		printf("\tRaw Data: %04x\n", secheader->PointerToRawData);
		printf("\tPointerToRelocations: %04x\n", secheader->PointerToRelocations);
		printf("\tPointerToLinenumbers: %04x\n", secheader->PointerToLinenumbers);
		printf("\tNumberOfRelocations: %02x\n", secheader->NumberOfRelocations);
		printf("\tNumberOfLinenumbers: %02x\n", secheader->NumberOfLinenumbers);
		printf("\tCharacteristics: %04x\n", secheader->Characteristics);
		printf("\t-------------------------\n");
		realoffset[n] = secheader->VirtualAddress - secheader->PointerToRawData;
		// printf("\nsubstract this from any RVA in this section : %x\n", realoffset[n]);
	}
	printf("\t#####End Of Sections#####\n\n");
	// End Pe Header
}
//end the section here 

void GetSection(unsigned char *buffer, char opt, unsigned char *sectionname){
	IMAGE_DOS_HEADER *dos;
	IMAGE_NT_HEADERS *ntheader;
	IMAGE_IMPORT_DESCRIPTOR *import_desc;
	PIMAGE_THUNK_DATA *names;

	int n, section_size = 0;
	int data_dir;
	char *data_dir_desc;
	unsigned char *section = (unsigned char *)malloc(8);
	int import_count = 0; //for count imports

	printf("\t########Begin Analyzing########\n");
	// Dos Header
	dos = (IMAGE_DOS_HEADER *)buffer;
	// End Dos Header
	// begin Pe Header
	unsigned char *PE_HEADER = (unsigned char *)malloc(sizeof(buffer[dos->e_lfanew])); //allocate
	PE_HEADER = &buffer[dos->e_lfanew];
	ntheader = (IMAGE_NT_HEADERS *)PE_HEADER;
	// printf("\t#####Section Header#####\n");
	int g=0;
	int result_section;
	int realoffset[ntheader->file_header.NumberOfSections];
	for(n=1;n<=ntheader->file_header.NumberOfSections;n++) {
		IMAGE_SECTION_HEADER *secheader = (IMAGE_SECTION_HEADER *)(PE_HEADER + sizeof(IMAGE_NT_HEADERS) + section_size);
		section_size += sizeof(IMAGE_SECTION_HEADER);
		sprintf(section, "%c%c%c%c%c%c%c%c", secheader->Name[0], secheader->Name[1], secheader->Name[2], secheader->Name[3], secheader->Name[4], secheader->Name[5], secheader->Name[6], secheader->Name[7]);
		if(strcmp(sectionname, section) == 0) {
			printf("\tSection Name: %c%c%c%c%c%c%c%c\n", secheader->Name[0], secheader->Name[1], secheader->Name[2], secheader->Name[3], secheader->Name[4], secheader->Name[5], secheader->Name[6], secheader->Name[7]);
			printf("\tVirtualSize: %04x\n", secheader->VirtualSize);
			printf("\tVirtualAddress: %04x\n", secheader->VirtualAddress);
			printf("\tSizeOfRawData: %04x\n", secheader->SizeOfRawData);
			printf("\tRaw Data: %04x\n", secheader->PointerToRawData);
			printf("\tPointerToRelocations: %04x\n", secheader->PointerToRelocations);
			printf("\tPointerToLinenumbers: %04x\n", secheader->PointerToLinenumbers);
			printf("\tNumberOfRelocations: %02x\n", secheader->NumberOfRelocations);
			printf("\tNumberOfLinenumbers: %02x\n", secheader->NumberOfLinenumbers);
			printf("\tCharacteristics: %04x\n", secheader->Characteristics);
			printf("\t-------------------------\n");
			realoffset[n] = secheader->VirtualAddress - secheader->PointerToRawData;
		}else if(strcmp(sectionname, section) != 0 && n < ntheader->file_header.NumberOfSections){
			continue;
		}else{
			printf("\tSection Not Found : %s (use -s option for listing all sections)\n");
			break;
		}

		// printf("\nsubstract this from any RVA in this section : %x\n", realoffset[n]);
	}
	// printf("\t#####End Of Sections#####\n\n");
	// End Pe Header
	printf("Got section name : %s\n", sectionname);
}










void CheckFormat(unsigned char *buffer, opdis_buf_t buffer2, char opt, unsigned char *extraopt){
	// unsigned char *format = malloc(4);
	// here we check file format we will begin with PE and ELF
		void *name;
		if(buffer[0] == 0x7f && buffer[1] == 0x45){
			printf("this file is ELF \n");
		}else if(buffer[0] == 0x4d && buffer[1] == 0x5a){
			printf("this file is PE file\n");
			if(opt == 'a')
				PeAnalyzer(buffer, opt);
			else if(opt == 'I')
				DumpImports(buffer, opt);
			else if(opt == 's')
				ListSections(buffer, opt);
			else if(opt == 'n')
				GetSection(buffer, opt, extraopt);
			else if(opt == 'N')
				DumpSecHex(buffer, opt, extraopt);
			else if(opt == 'S')
				DumpStrings(buffer, opt, extraopt);
			else if(opt == 'd')
				Disassemble(buffer, buffer2, name, opt);
			else if(opt == 'c')
				DisassembleFlow(buffer, buffer2, name, opt);
		}
	// free(format);
}


int main(int argc, char **argv){
	if(argc < 2){
		Usage(argv[0]);
		return(0);
	}
	// usage begin
	int option = 0;
	char optgot;
		// usage end
	int i, file_len;
	FILE *f;
	unsigned char *buffer;
	FILE *fopdis;
	opdis_buf_t buffer2;
	
	// CheckFormat(buffer);
	while ((option = getopt(argc, argv, "a:I:s:n:N:S:d:c:")) != -1){
		switch(option){
			case 'a':
				printf("file name inserted is %s\n", optarg);
				f = fopen(optarg, "rb");
				// now printing file size
				fseek(f, 0, SEEK_END);
				file_len = ftell(f);
				fseek(f, 0, SEEK_SET);
				printf("file size: %d KB\n", file_len / 1024);
				buffer = (unsigned char *)malloc(file_len); //allocate
				// now time to read the contents of the file
				fread(buffer, file_len, 1, f);
				CheckFormat(buffer, buffer2,'a', DEFAULT);
				free(buffer);
				fclose(f);
				break;
			case 'I':
				printf("file name inserted is %s\n", optarg);
				f = fopen(optarg, "rb");
				// now printing file size
				fseek(f, 0, SEEK_END);
				file_len = ftell(f);
				fseek(f, 0, SEEK_SET);
				printf("file size: %d bytes\n", file_len);
				buffer = (unsigned char *)malloc(file_len); //allocate
				// now time to read the contents of the file
				fread(buffer, file_len, 1, f);
				CheckFormat(buffer, buffer2,'I', DEFAULT);
				fclose(f);
				break;
			case 's':
				printf("file name inserted is %s\n", optarg);
				f = fopen(optarg, "rb");
				// now printing file size
				fseek(f, 0, SEEK_END);
				file_len = ftell(f);
				fseek(f, 0, SEEK_SET);
				printf("file size: %d bytes\n", file_len);
				buffer = (unsigned char *)malloc(file_len); //allocate
				// now time to read the contents of the file
				fread(buffer, file_len, 1, f);
				CheckFormat(buffer, buffer2, 's', DEFAULT);
				fclose(f);
				break;
			case 'n':
				if(argc < 4){
					printf("option not completed -n <section name> <filename>\n");
					exit(-1);
				}
				printf("file name inserted is %s\n", argv[3]);
				f = fopen(argv[3], "rb");
				// now printing file size
				fseek(f, 0, SEEK_END);
				file_len = ftell(f);
				fseek(f, 0, SEEK_SET);
				printf("file size: %d bytes\n", file_len);
				buffer = (unsigned char *)malloc(file_len); //allocate
				// now time to read the contents of the file
				fread(buffer, file_len, 1, f);
				// printf("you choosed option with arg %s, %s", optarg, argv[3]);
				CheckFormat(buffer, buffer2, 'n', optarg);
				fclose(f);
				break;
			case 'N':
				if(argc < 4){
					printf("option not completed -N <section name> <filename>\n");
					exit(-1);
				}
				printf("file name inserted is %s\n", argv[3]);
				f = fopen(argv[3], "rb");
				// now printing file size
				fseek(f, 0, SEEK_END);
				file_len = ftell(f);
				fseek(f, 0, SEEK_SET);
				printf("file size: %d bytes\n", file_len);
				buffer = (unsigned char *)malloc(file_len); //allocate
				// now time to read the contents of the file
				fread(buffer, file_len, 1, f);
				// printf("you choosed option with arg %s, %s", optarg, argv[3]);
				CheckFormat(buffer, buffer2, 'N', optarg);
				fclose(f);
				break;
			case 'S':
				if(argc < 4){
					printf("option not completed -S <section name> <filename>\n");
					exit(-1);
				}
				printf("file name inserted is %s\n", argv[3]);
				f = fopen(argv[3], "rb");
				// now printing file size
				fseek(f, 0, SEEK_END);
				file_len = ftell(f);
				fseek(f, 0, SEEK_SET);
				printf("file size: %d bytes\n", file_len);
				buffer = (unsigned char *)malloc(file_len); //allocate
				// now time to read the contents of the file
				fread(buffer, file_len, 1, f);
				// printf("you choosed option with arg %s, %s", optarg, argv[3]);
				CheckFormat(buffer, buffer2, 'S', optarg);
				fclose(f);
				break;
			case 'd':
				// here declare for opdis
				fopdis = fopen(optarg, "r");
				buffer2 = opdis_buf_read(fopdis,0,0);
				// here end declaration of opdis
				printf("file name inserted is %s\n", optarg);
				f = fopen(optarg, "rb");
				// now printing file size
				fseek(f, 0, SEEK_END);
				file_len = ftell(f);
				fseek(f, 0, SEEK_SET);
				printf("file size: %d KB\n", file_len / 1024);
				buffer = (unsigned char *)malloc(file_len); //allocate
				// now time to read the contents of the file
				fread(buffer, file_len, 1, f);
				CheckFormat(buffer, buffer2, 'd', DEFAULT);
				free(buffer);
				fclose(f);
				fclose(fopdis);
				break;
			case 'c':
				// here declare for opdis
				fopdis = fopen(optarg, "r");
				buffer2 = opdis_buf_read(fopdis,0,0);
				// here end declaration of opdis
				printf("file name inserted is %s\n", optarg);
				f = fopen(optarg, "rb");
				// now printing file size
				fseek(f, 0, SEEK_END);
				file_len = ftell(f);
				fseek(f, 0, SEEK_SET);
				printf("file size: %d KB\n", file_len / 1024);
				buffer = (unsigned char *)malloc(file_len); //allocate
				// now time to read the contents of the file
				fread(buffer, file_len, 1, f);
				CheckFormat(buffer, buffer2, 'c', DEFAULT);
				free(buffer);
				fclose(f);
				fclose(fopdis);
				break;
			default:
				printf("Please Choose nicely\n");
				exit(-1);
		}
	}
	return(-1);
}